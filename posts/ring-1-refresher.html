<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ring 1 — Borrower-level Aggregation (SAS)</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    body { font-family: system-ui, sans-serif; background: #f9fafb; color: #111827; margin: 0; padding: 0; }
    .container { max-width: 960px; margin: auto; padding: 24px; }
    header { margin-bottom: 24px; }
    header h1 { font-size: 1.8rem; margin: 0 0 8px; color: #0f172a; }
    header p { color: #6b7280; margin: 0; }
    a.back { display: inline-block; margin-bottom: 18px; text-decoration: none; color: #2563eb; font-size: 0.95rem; }
    a.back:hover { text-decoration: underline; }
    .card { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06); }
    h2 { margin-top: 24px; margin-bottom: 12px; color: #1d4ed8; font-size: 1.2rem; }
    p.lead { margin-bottom: 16px; color: #374151; }
    table { border-collapse: collapse; width: 100%; margin: 12px 0 20px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; font-family: monospace; font-size: 0.95rem; }
    .code { background: #111827; color: #e5e7eb; padding: 14px; border-radius: 8px; overflow: auto; font-size: 0.9rem; line-height: 1.5; margin-bottom: 18px; }
    .note { background: #f1f5f9; border-left: 4px solid #2563eb; padding: 10px 14px; border-radius: 6px; margin-bottom: 16px; color: #374151; font-size: 0.95rem; }
    footer { margin-top: 40px; text-align: center; color: #6b7280; font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <a href="../index.html" class="back">← Back to home</a>
    <header>
      <h1>Ring 1 — Borrower-level Aggregation (SAS)</h1>
      <p>Warm-up exercise derived from ChatGPT conversation</p>
    </header>

    <div class="card">
      <p class="lead">
        This exercise demonstrates borrower-level aggregation on a simple loan dataset using SAS.
        Two approaches are presented: <strong>PROC SQL</strong> (set-based) and <strong>DATA step</strong> (row-by-row with BY-group processing).
      </p>

      <h2>Sample Data</h2>
      <table>
        <thead>
          <tr><th>Borrower_ID</th><th>Loan_ID</th><th>Balance</th><th>Payment</th><th>Month</th></tr>
        </thead>
        <tbody>
          <tr><td>1001</td><td>L1</td><td>5000</td><td>200</td><td>202401</td></tr>
          <tr><td>1001</td><td>L2</td><td>2000</td><td>100</td><td>202401</td></tr>
          <tr><td>1002</td><td>L3</td><td>8000</td><td>300</td><td>202401</td></tr>
          <tr><td>1002</td><td>L4</td><td>6000</td><td>250</td><td>202401</td></tr>
          <tr><td>1003</td><td>L5</td><td>4000</td><td>150</td><td>202401</td></tr>
        </tbody>
      </table>

      <h2>Task</h2>
      <ul>
        <li>Total_Balance = sum(Balance)</li>
        <li>Total_Payment = sum(Payment)</li>
        <li>Num_Loans = count(Loan_ID)</li>
        <li>Avg_Payment_Ratio = Total_Payment / Total_Balance</li>
      </ul>

      <h2>Solution — PROC SQL</h2>
      <div class="note">Use <code>sum(Payment)/sum(Balance)</code> directly instead of CALCULATED inside aggregates.</div>
      <div class="code"><pre>
proc sql;
  create table borrower_summary as
  select 
    Borrower_ID,
    Month,
    sum(Balance) as Tot_Balance,
    sum(Payment) as Tot_Payment,
    count(Loan_ID) as Num_Loans,
    sum(Payment) / sum(Balance) as Avg_Pymt_Ratio
  from table1
  group by Borrower_ID, Month;
quit;
      </pre></div>

      <h2>Solution — DATA Step + BY-group Processing</h2>
      <div class="code"><pre>
proc sort data=table1; by Borrower_ID Month; run;

data borrower_summary;
  retain Tot_Balance Tot_Payment Num_Loans;
  set table1;
  by Borrower_ID Month;

  if first.Month then do;
    Tot_Balance = 0;
    Tot_Payment = 0;
    Num_Loans = 0;
  end;

  Tot_Balance + Balance;
  Tot_Payment + Payment;
  Num_Loans + 1;

  if last.Month then do;
    Avg_Pymt_Ratio = Tot_Payment / Tot_Balance;
    output;
  end;
run;
      </pre></div>

      <h2>Alternative — Mean of Loan-Level Ratios</h2>
      <div class="code"><pre>
proc sql;
  create table loan_ratios as
  select Borrower_ID, Month, Payment/Balance as loan_ratio
  from table1;

  create table borrower_avg_ratio as
  select Borrower_ID, Month, mean(loan_ratio) as Avg_LoanLevel_Ratio
  from loan_ratios
  group by Borrower_ID, Month;
quit;
      </pre></div>

      <h2>Key Takeaways</h2>
      <ul>
        <li>Ratio of sums (<code>sum(payment)/sum(balance)</code>) gives overall borrower payment capacity.</li>
        <li>Mean of loan-level ratios gives average behavior across loans.</li>
        <li>Be careful with typos (e.g., <code>balacen</code> → <code>Balance</code>).</li>
      </ul>

      <h2>Original ChatGPT Conversation</h2>
      <p><a href="https://chatgpt.com/share/68da2596-c45c-8005-9d07-bf528070bfcb" target="_blank" style="color:#2563eb; text-decoration:none;">View full ChatGPT conversation</a></p>

    </div>

    <footer>
      <p>© 2025 My Learning Journal</p>
    </footer>
  </div>
</body>
</html>
