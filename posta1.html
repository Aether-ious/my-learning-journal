<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ring 1 — Refresher: Borrower-level Aggregation (SAS)</title>
  <link rel="stylesheet" href="../style.css">
  <style>
    /* Small post-specific styles to make this page self-contained */
    .post-wrap { max-width: 980px; margin: 36px auto; padding: 28px; background: #fff; border-radius: 12px; box-shadow: 0 8px 30px rgba(15,23,42,0.06); }
    .meta { color: #6b7280; font-size: .95rem; margin-bottom: 18px; }
    h1 { color: #0f172a; margin-bottom: 6px; font-size: 1.8rem; }
    h2 { color: #0b69ff; margin-top: 26px; margin-bottom: 12px; font-size: 1.15rem; }
    p.lead { color: #374151; margin-bottom: 12px; }
    table.sample { border-collapse: collapse; width: 100%; margin: 12px 0 22px; }
    table.sample th, table.sample td { padding: 8px 10px; border: 1px solid #e6eef8; text-align: left; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; }
    .code { background:#0b1220; color:#e6eef8; padding: 14px; border-radius: 8px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size: 0.95rem; line-height:1.5; }
    .code pre { margin:0; white-space: pre; }
    .btn-copy { float: right; background: #0f172a; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: .85rem; }
    .small { font-size: .95rem; color:#4b5563; }
    .note { background: #f1f5f9; border-left: 4px solid #0b69ff; padding: 10px 12px; border-radius: 6px; margin-top: 14px; }
    .chat-link { display:inline-block; margin-top:10px; color:#0b69ff; text-decoration:none; font-weight:600; }
    .back { display:inline-block; margin-bottom: 8px; color:#374151; text-decoration:none; font-size:.95rem; }
  </style>
</head>
<body>
  <div class="post-wrap" role="main">
    <a class="back" href="../index.html">← Back to home</a>
    <h1>Ring 1 — Refresher: Borrower-level Aggregation (SAS)</h1>
    <div class="meta">Warm-up exercise • Sep 29, 2025</div>

    <p class="lead">We warm up with a banking-like toy dataset. For each <code>Borrower_ID</code> + <code>Month</code> compute total balance, total payment, loan count and payment ratio. Two canonical SAS approaches are shown below: <strong>PROC SQL</strong> (set-based) and <strong>DATA step + BY-group aggregation</strong> (row-by-row accumulation).</p>

    <h2>Sample data</h2>
    <table class="sample" aria-label="sample loan table">
      <thead>
        <tr><th>Borrower_ID</th><th>Loan_ID</th><th>Balance</th><th>Payment</th><th>Month</th></tr>
      </thead>
      <tbody>
        <tr><td>1001</td><td>L1</td><td>5000</td><td>200</td><td>202401</td></tr>
        <tr><td>1001</td><td>L2</td><td>2000</td><td>100</td><td>202401</td></tr>
        <tr><td>1002</td><td>L3</td><td>8000</td><td>300</td><td>202401</td></tr>
        <tr><td>1002</td><td>L4</td><td>6000</td><td>250</td><td>202401</td></tr>
        <tr><td>1003</td><td>L5</td><td>4000</td><td>150</td><td>202401</td></tr>
      </tbody>
    </table>

    <h2>Task</h2>
    <p class="small">For each <code>Borrower_ID</code> and <code>Month</code> compute:</p>
    <ul>
      <li>Total_Balance = sum(Balance)</li>
      <li>Total_Payment = sum(Payment)</li>
      <li>Num_Loans = count(Loan_ID)</li>
      <li>Avg_Payment_Ratio = Total_Payment / Total_Balance</li>
    </ul>

    <h2>Solution — PROC SQL (set-based)</h2>
    <div class="note small">Common gotchas fixed: typos (e.g., <code>balacen</code>), alias naming (no spaces), and prefer <code>SUM()</code> ratio instead of trying to use <code>CALCULATED</code> inside another aggregate.</div>

    <div class="code" id="code-sql">
      <button class="btn-copy" data-target="code-sql">Copy</button>
<pre>
proc sql;
  create table borrower_summary as
  select
    Borrower_ID,
    Month,
    sum(Balance)  as Tot_Balance,
    sum(Payment)  as Tot_Payment,
    count(Loan_ID) as Num_Loans,
    /* ratio of sums — stable and what you asked for */
    sum(Payment) / sum(Balance) as Avg_Pymt_Ratio
  from table1
  group by Borrower_ID, Month
  ;
quit;
</pre>
    </div>

    <h2>Solution — DATA step with BY-group accumulation</h2>
    <p class="small">Classic SAS row-by-row aggregator. Sort first, then use <code>first./last.</code> markers and running sums.</p>

    <div class="code" id="code-data">
      <button class="btn-copy" data-target="code-data">Copy</button>
<pre>
/* sort by grouping keys first */
proc sort data=table1; by Borrower_ID Month; run;

/* accumulate using BY-group processing */
data borrower_summary;
  retain Tot_Balance Tot_Payment Num_Loans;
  set table1;
  by Borrower_ID Month;

  if first.Month then do;
    Tot_Balance = 0;
    Tot_Payment = 0;
    Num_Loans = 0;
  end;

  Tot_Balance + Balance;
  Tot_Payment + Payment;
  Num_Loans + 1;

  if last.Month then do;
    Avg_Pymt_Ratio = Tot_Payment / Tot_Balance;
    output;
  end;
run;
</pre>
    </div>

    <h2>Quick alternative: mean of loan-level ratios</h2>
    <p class="small">If instead you want the <strong>average of per-loan Payment/Balance ratios</strong> (i.e., mean of the loan-level ratios), you must compute each loan's ratio and then average it. Example (PROC SQL with subquery):</p>

    <div class="code" id="code-mean">
      <button class="btn-copy" data-target="code-mean">Copy</button>
<pre>
proc sql;
  create table loan_ratios as
  select Borrower_ID, Month, Payment/Balance as loan_ratio
  from table1;

  create table borrower_avg_ratio as
  select Borrower_ID, Month, mean(loan_ratio) as Avg_LoanLevel_Ratio
  from loan_ratios
  group by Borrower_ID, Month;
quit;
</pre>
    </div>

    <h2>Notes & tips</h2>
    <ul>
      <li><strong>Ratio of sums vs mean of ratios:</strong> <em>sum(payment)/sum(balance)</em> gives an overall borrower-level payment capacity; <em>mean(payment/balance)</em> gives average loan-level behavior. They're different and both useful depending on the question.</li>
      <li>Be careful with variable
